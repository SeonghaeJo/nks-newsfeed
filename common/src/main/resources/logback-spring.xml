<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <springProperty scope="context" name="applicationName" source="spring.application.name" defaultValue="unknown"/>

    <!-- Console Appender - JSON format -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>component</includeMdcKeyName>
            <includeMdcKeyName>clientComponent</includeMdcKeyName>
            <includeContext>false</includeContext>
            <includeCallerData>false</includeCallerData>
        </encoder>
    </appender>

    <!-- Async Appender for Console -->
    <appender name="ASYNC_CONSOLE" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>false</neverBlock>
        <appender-ref ref="CONSOLE"/>
    </appender>

    <!-- Local profile - Console with pretty print -->
    <springProfile name="local">
        <appender name="CONSOLE_LOCAL" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <includeMdcKeyName>requestId</includeMdcKeyName>
                <includeMdcKeyName>traceId</includeMdcKeyName>
                <includeMdcKeyName>userId</includeMdcKeyName>
                <includeMdcKeyName>component</includeMdcKeyName>
                <includeMdcKeyName>clientComponent</includeMdcKeyName>
                <includeContext>false</includeContext>
                <includeCallerData>false</includeCallerData>
                <jsonGeneratorDecorator class="net.logstash.logback.decorate.PrettyPrintingJsonGeneratorDecorator"/>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="CONSOLE_LOCAL"/>
        </root>

        <logger name="com.personal.nksnewfeed" level="DEBUG"/>
        <logger name="org.springframework.cloud.gateway" level="DEBUG"/>
    </springProfile>

    <!-- Production profile - Async Console only (K8s + Fluent-bit) -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="ASYNC_CONSOLE"/>
        </root>

        <logger name="com.personal.nksnewfeed" level="INFO"/>
    </springProfile>

    <!-- Default profile - Async Console -->
    <springProfile name="!local &amp; !prod">
        <root level="INFO">
            <appender-ref ref="ASYNC_CONSOLE"/>
        </root>

        <logger name="com.personal.nksnewfeed" level="DEBUG"/>
    </springProfile>
</configuration>